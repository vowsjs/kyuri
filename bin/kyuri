#!/usr/bin/env node

var path   = require('path'),
    sys    = require('sys'),
    fs     = require('fs'),
    events = require('events');

featureFileExt = /\.(feature)$/;
stepsDirs = ['steps', 'step_definitions'];
envDirs = ['support'];

var inspect = require('eyes').inspector({
    stream: null,
    styles: { string: 'grey', regexp: 'grey' }
});

require.paths.unshift(path.join(__dirname, '..', 'lib'));

var kyuri = require('kyuri');

var help = [
    "usage: kyuri [FILE, ...]"
].join('\n');

var root = process.cwd();

/**
  Load .js files found in the directory or subdirectories of the feature files,
  adding exports to the steps array (if any).
*/
var _loadJavascripts = function (directory, steps) {
  if (!directory.match(/^\//)) {
    directory = path.join(root, directory);
  }

  if(path.existsSync(directory)) {
    var files = fs.readdirSync(directory);
    files.forEach(function (file) {
      var fullPath = path.join(directory, file),
        stats = fs.statSync(fullPath),
        exported;
    
      if (stats.isDirectory()) {
        _loadJavascripts(fullPath, steps);
      } else {
        if (file.match(/\.js$/)) {
          // Add root to all relative paths
          if (!fullPath.match(/^\//)) {
            fullPath = path.join(root, fullPath);
          }
          console.log('Loaded ' + fullPath);
          exported = require(fullPath);
          if (exported && exported.forEach && steps) {
            exported.forEach(function (obj) {
              steps.push(obj); // Pass-by-reference array must be modified in place
            })
          }
        }
      }
    }); 
  }
};

// Get rid of process runner
// ('node' in most cases)
var arg, args = [], argv = process.argv.slice(2);

kyuri.runner = kyuri.runners.cucumber;

var features = [];
var steps = [];
argv.forEach(function (file) {
  if (file.match(featureFileExt)) {
    // Load envDirs first and without steps
    envDirs.forEach(function (dir) {
      _loadJavascripts(path.join(path.dirname(file), dir)); 
    });
    // Load steps
    stepsDirs.forEach(function (dir) {
      _loadJavascripts(path.join(path.dirname(file), dir), steps);
    });
    features.push(kyuri.parse(fs.readFileSync(file).toString()));
  }
});

var complete = false;

kyuri.runners.cucumber.run(features, steps, function (err) {
  if (err) {
    console.log('Errors');
    console.log(err);
  }
  complete = true;
});

var _waitComplete = function () {
  if (!complete) {
    process.nextTick(_waitComplete);
  }
};
_waitComplete();
